
def extension

class Shortcut{
    def destType = 'desktop' //desktop:D, startMenu:P, startup:S
    def srcName = ''
    def destFolder = ''
    def desc = ''
    def shortcutName = ''
    def shortcutIcon = ''
}

//class RarTask extends Exec 
class RarTask extends DefaultTask
{
    @Input def version = '-----'
    @Input def release = '-----'
    
    @InputDirectory def File outputDir = null

    @Input def shortcut = new Shortcut()

    @Input def extractLocation = ''
    @Input def extractDir = ''
    @Input def git_message = ''
    @Input def git_message_title = ''


    @TaskAction def doThis() 
    {
        def sfxConfigFile = project.file("$outputDir/SFX-package.conf")

        def destTypeMap = ['desktop':'D', 'startMenu':'P', 'startup':'S']
        shortcut.destType = destTypeMap[shortcut.destType]

        def extractLocationMap = ['program files':'', 'current':'.\\']
        extractLocation = extractLocationMap[ extractLocation ]
        

        sfxConfigFile.write generateSFXConfig();
    }

    def generateSFXConfig()
    {
        
        //using Dollar Slashy String $/.../$ read[http://docs.groovy-lang.org/latest/html/documentation/#_dollar_slashy_string]
        def htmlText = $/
;-------------------------------
; This file is generated as a config file to generate SFX rar
; ${version}
;

; run after install
;Setup=eQuiz-client.exe -h 10.4.10.100 -p 10000

; initial Installation folder
; Path=.\eQuiz  --> sets initial to Current.
; Path=eQuiz    --> sets initial to "Program Files" dir.
Path=${extractLocation}${extractDir}

;save the initial folder for later installation
;SavePath

; Careate shortcut on Desktop
; Shortcut=<DestType>,<SrcName>,<DestFolder>,<Description>,<ShortcutName>,<ShortcutIcon> 
Shortcut=${shortcut.destType}, ${shortcut.srcName}, ${shortcut.destFolder}, ${shortcut.desc}, ${shortcut.shortcutName}, ${shortcut.shortcutIcon}

; Extract the files to a temporary directory
;TempMode

; Use semi-silent mode
; 0-show setup , 
; 1-completely sielent (nothing shown),
; 2-show setup and run sielently
Silent=0

; Overwrite any existing files
Overwrite=1

; The title of the SFX archive
Title=eQuiz, Cient, manga ${version}

; The text to show initially when the user clicks on the SFX archive (will only matter if using Silent=0)
Text
{
<pre style="color: blue; font-weight: bold ">
Product     : manga ${version} 
Released on : ${release} 

What's A New:
</pre>
<pre style="color: green; font-weight: bold ">${git_message_title}</pre>
<pre>${git_message}</pre>
}    
        /$;
        return htmlText;
    }


}//end class AboutTask


task stopTomcat(type:Exec) {
    def stdout = new ByteArrayOutputStream()
    //git log -n 1 --format=format:%B
    
    commandLine 'git', 'log', '-n', '1', '--format=format:%B'
    standardOutput = stdout

    //def git_message =  stdout.toString().trim()
    println stdout.toString().trim()
}

task makeSFXConfig(type: RarTask, dependsOn: stopTomcat) 
task makeSFX(dependsOn: 'makeSFXConfig')  


